---
import { getCollection } from "astro:content";
import bespinianWhite from "../assets/bespinian-white.svg";
import bespinianBlue from "../assets/bespinian-blue.svg";
import Link from "./Link.astro";
import LanguageSelector from "./LanguageSelector.astro";
import { useI18n } from "../i18n/utils";

interface MenuItem {
  label: string;
  href: string;
  submenu?: { label: string; href: string }[];
}

const { lang, t, translatePath } = useI18n(Astro.url);

const servicesFromContent = await getCollection("services", ({ id }) => {
  return id === lang;
});

const servicesData =
  servicesFromContent.length > 0 ? (servicesFromContent[0]?.data ?? []) : [];

const mainItems: MenuItem[] = [
  {
    label: t("nav.services"),
    href: translatePath("/#services"),
    submenu: servicesData.map((service) => ({
      label: service.title,
      href: translatePath(`/services/${service.id}`),
    })),
  },
  { label: t("nav.customers"), href: translatePath("/customers") },
  {
    label: t("nav.about"),
    href: translatePath("/about"),
    submenu: [
      { label: t("about.mission.title"), href: translatePath("/about") },
      { label: t("about.team.title"), href: translatePath("/about/team") },
      {
        label: t("about.partners.title"),
        href: translatePath("/about/partners"),
      },
      {
        label: t("about.technologies.title"),
        href: translatePath("/about/technologies"),
      },
      { label: t("jobs.title"), href: translatePath("/about/jobs") },
    ],
  },
  { label: t("nav.contact"), href: translatePath("/contact") },
  { label: t("nav.blog"), href: translatePath("/blog") },
];
---

<nav>
  <a href={translatePath("/")}>
    <img id="logo" src={bespinianWhite.src} alt="bespinian logo" />
  </a>

  <ul class="nav-desktop">
    {
      mainItems.map((i) => (
        <li class={i.submenu ? "dropdown" : ""}>
          <a href={i.href}>{i.label}</a>
          {i.submenu && (
            <ul class="dropdown-menu">
              {i.submenu.map((subItem) => (
                <li>
                  <a href={subItem.href}>{subItem.label}</a>
                </li>
              ))}
            </ul>
          )}
        </li>
      ))
    }
  </ul>

  <ul class="nav-desktop">
    <li>
      <Link href={translatePath("/workshop")} secondary
        >{t("cta.freeWorkshop")}</Link
      >
    </li>
    <li>
      <LanguageSelector
        currentLang={lang}
        currentPath={Astro.url.pathname}
        mobile={false}
      />
    </li>
  </ul>

  <button id="modal-open" aria-label="Open menu" class="button hamburger">
    <span></span>
    <span></span>
    <span></span>
  </button>
</nav>

<div id="modal" class="hidden">
  <div id="modal-head">
    <a href={translatePath("/")}>
      <img id="modal-logo" src={bespinianBlue.src} alt="bespinian logo" />
    </a>
    <button id="modal-close" aria-label="Close menu" class="button hamburger">
      <span></span>
      <span></span>
      <span></span>
    </button>
  </div>

  <div id="modal-main">
    <ul>
      {
        mainItems.map((i) => (
          <li class={i.submenu ? "mobile-dropdown" : ""}>
            <a href={i.href} class="menu-link">
              {i.label}
              {i.submenu && <span class="dropdown-arrow">â–¼</span>}
            </a>
            {i.submenu && (
              <ul class="mobile-submenu">
                {i.submenu.map((subItem) => (
                  <li>
                    <a href={subItem.href} class="menu-link">
                      {subItem.label}
                    </a>
                  </li>
                ))}
              </ul>
            )}
          </li>
        ))
      }
    </ul>

    <div class="modal-footer">
      <Link href={translatePath("/workshop")}>{t("cta.freeWorkshop")}</Link>
      <LanguageSelector
        currentLang={lang}
        currentPath={Astro.url.pathname}
        mobile={true}
      />
    </div>
  </div>
</div>

<script>
  const openButton = document.getElementById("modal-open");
  const closeButton = document.getElementById("modal-close");
  const modal = document.getElementById("modal");

  openButton?.addEventListener("click", () => {
    const modal = document.getElementById("modal");
    modal?.classList.remove("hidden");
    modal?.classList.remove("closing");
  });

  closeButton?.addEventListener("click", () => {
    if (modal) {
      modal.classList.add("closing");
      setTimeout(() => {
        modal.classList.add("hidden");
        modal.classList.remove("closing");
      }, 300); // Match animation duration
    }
  });

  // Close modal when any navigation link is clicked
  document.querySelectorAll(".menu-link").forEach((link) => {
    link.addEventListener("click", (e) => {
      const parent = link.parentElement;
      const hasSubmenu = parent?.classList.contains("mobile-dropdown");

      // If this is a dropdown toggle link, prevent default and toggle submenu
      if (hasSubmenu) {
        e.preventDefault();
        const submenu = parent?.querySelector(".mobile-submenu");
        const arrow = parent?.querySelector(".dropdown-arrow");

        if (submenu) {
          submenu.classList.toggle("expanded");
          arrow?.classList.toggle("expanded");
        }
      } else {
        // If this is a regular link or submenu link, close the modal
        if (modal) {
          modal.classList.add("closing");
          setTimeout(() => {
            modal.classList.add("hidden");
            modal.classList.remove("closing");
          }, 300);
        }
      }
    });
  });
</script>

<style>
  nav {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 2rem;
    height: 3rem;
    font-size: 1.5rem;
    background-color: var(--color-background-primary);
    color: var(--color-secondary);
  }

  #logo {
    height: 100%;
  }

  .nav-desktop {
    display: none;
    gap: 2rem;
    list-style-type: none;
  }

  a {
    text-decoration: none;
    height: 100%;
    color: inherit;
  }

  a:hover {
    color: var(--color-primary);
  }

  #modal {
    z-index: 999999;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    padding: 2rem;
    font-size: 1.3rem;
    background-color: var(--color-secondary);
    color: var(--color-primary);
    animation: slideDown 0.3s ease-out;
  }

  @keyframes slideDown {
    from {
      transform: translateY(-100%);
      opacity: 0;
    }
    to {
      transform: translateY(0);
      opacity: 1;
    }
  }

  @keyframes slideUp {
    from {
      transform: translateY(0);
      opacity: 1;
    }
    to {
      transform: translateY(-100%);
      opacity: 0;
    }
  }

  #modal.closing {
    animation: slideUp 0.3s ease-in forwards;
  }

  .button {
    background: none;
    color: inherit;
    border: none;
    padding: 0;
    font: inherit;
    cursor: pointer;
    outline: inherit;
  }

  .button:hover {
    color: var(--color-background-tertiary);
  }

  .hamburger {
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    width: 1.75rem;
    height: 1.5rem;
    padding: 0.25rem 0;
  }

  .hamburger span {
    display: block;
    width: 100%;
    height: 2px;
    background-color: currentColor;
    transition: all 0.3s ease;
  }

  #modal-close.hamburger {
    position: relative;
    top: 1rem;
  }

  #modal-close.hamburger span:nth-child(1) {
    position: absolute;
    top: 50%;
    transform: rotate(45deg);
  }

  #modal-close.hamburger span:nth-child(2) {
    opacity: 0;
  }

  #modal-close.hamburger span:nth-child(3) {
    position: absolute;
    top: 50%;
    transform: rotate(-45deg);
  }

  #modal-head {
    height: 3rem;
    display: flex;
    justify-content: space-between;
    margin-bottom: 4rem;
  }

  #modal-logo {
    height: 100%;
  }

  #modal-main ul {
    list-style: none;
    padding: 0;
  }

  #modal-main li {
    margin-top: 1.5rem;
  }

  .modal-footer {
    margin-top: 3rem;
    padding-top: 2rem;
    border-top: 1px solid var(--color-background-primary);
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
    align-items: flex-start;
  }

  .hidden {
    display: none;
  }

  /* Desktop dropdown styles */
  .dropdown {
    position: relative;
  }

  .dropdown-arrow {
    margin-left: 0.35rem;
    font-size: 0.75rem;
    transition: transform 0.2s ease;
    display: inline-block;
  }

  .dropdown:hover .dropdown-arrow {
    transform: rotate(180deg);
  }

  .mobile-dropdown .dropdown-arrow.expanded {
    transform: rotate(180deg);
  }

  .dropdown-menu {
    display: none;
    position: absolute;
    top: 100%;
    left: 0;
    background-color: var(--color-secondary);
    color: var(--color-primary);
    list-style-type: none;
    padding: 0.5rem 0;
    margin: 0;
    min-width: 12rem;
    box-shadow: 0 8px 16px rgba(0, 0, 0, 0.25);
    border-radius: 12px;
    z-index: 1000;
  }

  .dropdown:hover .dropdown-menu {
    display: block;
  }

  .dropdown-menu li {
    padding: 0;
  }

  .dropdown-menu a {
    display: block;
    padding: 0.75rem 1.5rem;
    white-space: nowrap;
  }

  .dropdown-menu a:hover {
    background-color: rgba(37, 99, 235, 0.1);
  }

  /* Mobile dropdown styles */
  .mobile-submenu {
    display: none;
    list-style: none;
    padding: 0;
    padding-left: 1rem;
    margin-top: 0.75rem;
    overflow: hidden;
    max-height: 0;
    opacity: 0;
    transition:
      max-height 0.3s ease-out,
      opacity 0.3s ease-out,
      margin-top 0.3s ease-out;
  }

  .mobile-submenu.expanded {
    display: block;
    max-height: 500px;
    opacity: 1;
    margin-top: 0.75rem;
  }

  .mobile-submenu li {
    margin-top: 0.75rem;
  }

  .mobile-submenu a {
    font-size: 1.1rem;
    opacity: 0.9;
  }

  @media (min-width: 80rem) {
    .nav-desktop {
      display: flex;
      align-items: center;
    }

    #modal-open {
      display: none;
    }
  }
</style>
